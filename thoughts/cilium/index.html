<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Cilium is an open source project to provide networking, security and observability for Kubernetes cluster an other container orchestration platforms."><title>Cilium</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Cilium"><meta property="og:image" content="https://digital-garden.erdrix.konpyutaika.com/glossary-feature.jpeg"><meta property="og:type" content="website"><meta property="og:url" content="https://digital-garden.erdrix.konpyutaika.com/thoughts/cilium/"><meta property="og:width" content="1119"><meta property="og:height" content="630"><meta name=twitter:card content="summary"><meta name=twitter:site content="@alexandreguitt"><meta name=twitter:title content="Cilium"><meta name=twitter:description content="Cilium is an open source project to provide networking, security and observability for Kubernetes cluster an other container orchestration platforms."><meta name=twitter:image content="https://digital-garden.erdrix.konpyutaika.com/glossary-feature.jpeg"><link rel="shortcut icon" type=image/png href=https://digital-garden.erdrix.konpyutaika.com//icon.png><link href=https://digital-garden.erdrix.konpyutaika.com/styles.b262430ef2eef00064c0c52a75f1c8dc.min.css rel=stylesheet><link href=https://digital-garden.erdrix.konpyutaika.com/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://digital-garden.erdrix.konpyutaika.com/js/darkmode.6542a1f168a1bef32cbea9e19276922d.min.js></script>
<script src=https://digital-garden.erdrix.konpyutaika.com/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://digital-garden.erdrix.konpyutaika.com/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://digital-garden.erdrix.konpyutaika.com/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://digital-garden.erdrix.konpyutaika.com/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://digital-garden.erdrix.konpyutaika.com/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://digital-garden.erdrix.konpyutaika.com/",fetchData=Promise.all([fetch("https://digital-garden.erdrix.konpyutaika.com/indices/linkIndex.ec82fe0e324c3ca483082944e369c269.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://digital-garden.erdrix.konpyutaika.com/indices/contentIndex.73095476af61234d21e50fc7a4a43ef4.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://digital-garden.erdrix.konpyutaika.com",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://digital-garden.erdrix.konpyutaika.com",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:2,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:8,scale:1.5})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{"’":"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/digital-garden.erdrix.konpyutaika.com\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156258629-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-156258629-2")</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://digital-garden.erdrix.konpyutaika.com/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><article><header><h1 id=page-title><a href=https://digital-garden.erdrix.konpyutaika.com/>Alexandre Guitton Digital Garden 🪴</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><a href=/tags><div class=darkmode><input class=toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle-bla tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 490 490" style="enable-background:new 0 0 35 35"><title>All Tags</title><path d="M64.333 490h58.401l33.878-137.69h122.259L245.39 490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04v-48.162H390.23L424.108.0H365.31l-33.878 138.661H208.79L242.668.0h-58.415l-33.864 138.661H32.411v48.162h106.298l-28.818 117.324h-77.48v48.162h65.8L64.333 490zM197.11 186.824h122.642l-29.2 117.324H168.292L197.11 186.824z"/></svg></label><label id=toggle-label-dark for=darkmode-togglead tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 490 490" style="enable-background:new 0 0 35 35"><title>All Tags</title><path d="M64.333 490h58.401l33.878-137.69h122.259L245.39 490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04v-48.162H390.23L424.108.0H365.31l-33.878 138.661H208.79L242.668.0h-58.415l-33.864 138.661H32.411v48.162h106.298l-28.818 117.324h-77.48v48.162h65.8L64.333 490zM197.11 186.824h122.642l-29.2 117.324H168.292L197.11 186.824z"/></svg></label></div></a><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><h1>Cilium</h1><p class=meta>Last updated
Unknown
- <a href=https://github.com/erdrix/digital-garden-git/tree/main/thoughts/cilium.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://digital-garden.erdrix.konpyutaika.com/tags/sapling/>Sapling</a></li><li><a href=https://digital-garden.erdrix.konpyutaika.com/tags/security/>Security</a></li><li><a href=https://digital-garden.erdrix.konpyutaika.com/tags/network/>Network</a></li><li><a href=https://digital-garden.erdrix.konpyutaika.com/tags/kubernetes/>Kubernetes</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#global-architecture>Global architecture</a><ol><li><a href=#cilium>Cilium</a></li><li><a href=#data-store>Data Store</a></li><li><a href=#observability-with-hubble>Observability with Hubble</a></li></ol></li><li><a href=#ebpf-datapath-linux-kernel>eBPF datapath: Linux Kernel</a></li><li><a href=#flow-traffic-control>Flow traffic control</a><ol><li><a href=#layer-3-policy>Layer 3 policy</a></li><li><a href=#layer-4-policy>Layer 4 policy</a></li><li><a href=#layer-7-policy>Layer 7 policy</a></li><li><a href=#egress-gateway>Egress gateway</a></li></ol></li><li><a href=#installation-concerns>Installation concerns</a><ol><li><a href=#specific-configurations>Specific Configurations</a></li></ol></li></ol></nav></details></aside><p><a href=https://cilium.io/get-started/ rel=noopener>Cilium</a> is an open source project to provide networking, security and observability for
<a href=/thoughts/Kubernetes/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes/>Kubernetes</a> cluster an other container orchestration platforms. At the foundation of Cilium is a new Linux kernel technology called
<a href=/thoughts/eBPF/ rel=noopener class=internal-link data-src=/thoughts/eBPF/>eBPF</a>, which enabled the dynamic insertion of powerful security, visibility, and networking control logic into the Linux kernel.</p><a href=#global-architecture><h2 id=global-architecture><span class=hanchor arialabel=Anchor># </span>Global architecture</h2></a><p><img src=https://digital-garden.erdrix.konpyutaika.com//thoughts/images/cilium_global_architecture.png width=auto alt></p><a href=#cilium><h3 id=cilium><span class=hanchor arialabel=Anchor># </span>Cilium</h3></a><ul><li><strong>Agent:</strong> runs on each node in the cluster. It accepts configuration via
<a href=/thoughts/Kubernetes/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes/>Kubernetes</a> or APIs that describes networking, service load-balancing,
<a href=/thoughts/Kubernetes-network-policies/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes-network-policies/>Kubernetes network policies</a>, and visibility & monitoring requirements. It listens for events from orchestration systems such as
<a href=/thoughts/Kubernetes/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes/>Kubernetes</a> to learn when containers or workloads are started and stopped. It manages the
<a href=/thoughts/eBPF/ rel=noopener class=internal-link data-src=/thoughts/eBPF/>eBPF</a> programs which the Linux kernel uses to control all network access in / out of those containers.</li><li><strong>Operator:</strong> is responsible for managing duties in the cluster which should logically be handled once for the entire cluster, rather than once for each node in the cluster. The Cilium
<a href=/thoughts/kubernetes-operator/ rel=noopener class=internal-link data-src=/thoughts/kubernetes-operator/>kubernetes operator</a> is not in the critical path for any forwarding or network policy decision.</li><li><strong><a href=/thoughts/container-network-inteface-plugin/ rel=noopener class=internal-link data-src=/thoughts/container-network-inteface-plugin/>CNI plugin</a>:</strong> is invoked by Kubernetes when a pod is scheduled or terminated on a node. It interacts with the Cilium API of the node to trigger the necessary datapath configuration to provide networking, load-balancing and
<a href=/thoughts/Kubernetes-network-policies/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes-network-policies/>Kubernetes network policies</a> for the pod.</li></ul><a href=#data-store><h3 id=data-store><span class=hanchor arialabel=Anchor># </span>Data Store</h3></a><p>Cilium requires a data store to propagate state between agents. It supports the following data stores:</p><ul><li><strong>Kubernetes CRDs (Default):</strong> The default choice to store any data and propagate state is to use
<a href=/thoughts/Kubernetes-CRD/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes-CRD/>Kubernetes Custom Resource Definition (CRD)</a>. CRDs are offered by
<a href=/thoughts/Kubernetes/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes/>Kubernetes</a> for cluster components to represent configurations and state via
<a href=/thoughts/Kubernetes/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes/>Kubernetes</a> resources.</li><li><strong>Key-Value Store</strong> <strong>(etcd):</strong> A key-value store can optionally be used as an optimization to improve the scalability of a cluster as change notifications and storage requirements are more efficient with direct key-value store usage</li></ul><a href=#observability-with-hubble><h3 id=observability-with-hubble><span class=hanchor arialabel=Anchor># </span>Observability with Hubble</h3></a><ul><li><strong>Server:</strong> runs on each node and retrieves the eBPF-based visibility from Cilium. It is embedded into the Cilium agent in order to achieve high performance and low-overhead. It offers a gRPC service to retrieve flows and Prometheus metrics.</li><li><strong>Relay:</strong> standalone component which is aware of all running Hubble servers and offers cluster-wide visibility by connecting to their respective gRPC APIs and providing an API that represents all servers in the cluster.</li><li><strong>Graphical UI:</strong> utilizes relay-based visibility to provide a graphical service dependency and connectivity map.</li></ul><a href=#ebpf-datapath-linux-kernel><h2 id=ebpf-datapath-linux-kernel><span class=hanchor arialabel=Anchor># </span>eBPF datapath: Linux Kernel</h2></a><p><a href=/thoughts/eBPF/ rel=noopener class=internal-link data-src=/thoughts/eBPF/>eBPF</a> is used to provide high-performance networking, multi-cluster and multi-cloud capabilities, advanced load balancing, transparent encryption, extensive network security capabilities, transparent observability, and much more.</p><p>Here is an example how the life of a packet, with
<a href=/thoughts/eBPF/ rel=noopener class=internal-link data-src=/thoughts/eBPF/>eBPF</a>.</p><p><img src=https://digital-garden.erdrix.konpyutaika.com//thoughts/images/cilium_ebpf_packer_life.png width=auto alt></p><ul><li><strong>Network endpoint (lxc)</strong>: Defines in Kubernetes as
<a href=https://docs.cilium.io/en/stable/network/kubernetes/ciliumendpoint/ rel=noopener>Cilium Endpoint</a> CR. It defines the network interface couple (one in the pod, another one on the host) that link the pod network to the host network.</li></ul><blockquote class=note-callout><p></p><p>Even if an endpoint is running, it doesn&rsquo;t mean it&rsquo;s ready.
<a href=https://docs.cilium.io/en/stable/security/policy/lifecycle/ rel=noopener>Here</a> is the graph states and their meanings.</p></blockquote><ul><li><strong>Barckley Packet Filter BPF</strong>: a technology used in certain computer operating systems for programs that need to, among other things, analyze network traffic. It provides a raw interface to data link layers, permitting raw link-layer packets to be sent and received.</li></ul><blockquote class=note-callout><p></p><p>I highly recommend anyone working with Cilium to watch this video:
<a href="https://www.youtube.com/watch?v=0BKU6avwS98&amp;t=494s" rel=noopener>Episode 51: Life of a Packet with Cilium</a>. It explains the basics of this scheme, and gives the commands and methodology for gaining visibility of the network flow, which is very useful for debugging.</p></blockquote><a href=#flow-traffic-control><h2 id=flow-traffic-control><span class=hanchor arialabel=Anchor># </span>Flow traffic control</h2></a><p>The configuration of the Cilium agent and the Cilium
<a href=/thoughts/Kubernetes-network-policies/ rel=noopener class=internal-link data-src=/thoughts/Kubernetes-network-policies/>network policy</a> determines whether an endpoint accepts traffic from a source or not. The agent can be put into the following three policy enforcement modes:</p><ul><li><strong>default:</strong> endpoints will start without any restrictions and as soon as a rule restricts their ability to receive traffic on ingress or to transmit traffic on egress, then the endpoint goes into whitelisting mode and all traffic must be explicitly allowed.</li><li><strong>always:</strong> policy enforcement is enabled on all endpoints even if no rules select specific endpoints.</li><li><strong>never:</strong> policy enforcement is disabled on all endpoints, even if rules do select specific endpoints.</li></ul><a href=#layer-3-policy><h3 id=layer-3-policy><span class=hanchor arialabel=Anchor># </span>Layer 3 policy</h3></a><p>Can be specified using the following methods:</p><ul><li><a href=https://docs.cilium.io/en/stable/security/policy/language/#labels-based rel=noopener>Labels Based</a>: used to describe the relationship if both endpoints are managed by Cilium and are thus assigned labels.</li><li><a href=https://docs.cilium.io/en/stable/security/policy/language/#services-based rel=noopener>Services based</a>: Intermediate form between Labels and CIDR and makes use of the services concept in the orchestration system.</li><li><a href=https://docs.cilium.io/en/stable/security/policy/language/#entities-based rel=noopener>Entities Based</a>: Entities are used to describe remote peers which can be categorized without knowing their IP addresses.</li><li><a href=https://docs.cilium.io/en/stable/security/policy/language/#cidr-based rel=noopener>IP/CIDR based</a>: used to describe the relationship to or from external services if the remote peer is not an endpoint.</li><li><a href=https://docs.cilium.io/en/stable/security/policy/language/#dns-based rel=noopener>DNS based</a>: Selects remote, non-cluster, peers using DNS names converted to IPs via DNS lookups. It shares all limitations of the
<a href=https://docs.cilium.io/en/stable/security/policy/language/#cidr-based rel=noopener>IP/CIDR based</a> rules above. DNS information is acquired by routing DNS traffic via a proxy, or polling for listed DNS targets. DNS TTLs are respected.</li></ul><a href=#layer-4-policy><h3 id=layer-4-policy><span class=hanchor arialabel=Anchor># </span>Layer 4 policy</h3></a><p>Layer 4 policy can be specified in addition to layer 3 policies or independently. It restricts the ability of an endpoint to emit and/or receive packets on a particular port using a particular protocol.</p><a href=#layer-7-policy><h3 id=layer-7-policy><span class=hanchor arialabel=Anchor># </span>Layer 7 policy</h3></a><p>Layer 7 policy rules are embedded into Layer 4 rules and can be specified for ingress and egress.</p><ul><li><strong>path:</strong> extended POSIX regex matched against the path of a request</li><li><strong>method:</strong> extended POSIX regex matched against the method of a request, e.g. <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>, …</li><li><strong>host:</strong> extended POSIX regex matched against the host header of a request, e.g. <code>foo.com</code></li><li><strong>headers:</strong> list of HTTP headers which must be present in the request</li></ul><blockquote class=warning-callout><p></p><p>DNS Proxy intercepts egress DNS traffic and records IPs seen in the responses. This interception is, itself, a
<a href=https://docs.cilium.io/en/stable/security/policy/language/#dns-proxy rel=noopener>separate policy rule governing the DNS requests</a>, and must be specified separately</p></blockquote><blockquote class=note-callout><p></p><p>Unlike layer 3 and layer 4 policies, violation of layer 7 rules does not result in packet drops. Instead, if possible, an application protocol specific access denied message is crafted and returned, e.g. an <em>HTTP 403 access denied</em> is sent back for HTTP requests which violate the policy, or a <em>DNS REFUSED</em> response for DNS requests.</p></blockquote><blockquote class=note-callout><p></p><p>Layer 7 rules are not currently supported in
<a href=https://docs.cilium.io/en/stable/security/policy/language/#hostpolicies rel=noopener>Host Policies</a>, i.e., policies that use
<a href=https://docs.cilium.io/en/stable/security/policy/intro/#nodeselector rel=noopener>Node Selector</a>.</p></blockquote><a href=#egress-gateway><h3 id=egress-gateway><span class=hanchor arialabel=Anchor># </span>Egress gateway</h3></a><p>[Egress Gateway — Cilium 1.14.0 documentation](
<a href=https://docs.cilium.io/en/stable/network/egress-gateway/ rel=noopener>https://docs.cilium.io/en/stable/network/egress-gateway/</a></p><p>Egress gateway feature routes all IPv4 connections originating from pods and destined to specific cluster-external CIDRs through particular nodes, from now on called “gateway nodes”. When enabled, matching packets that leave the cluster are masqueraded with selected, predictable IPs associated with the gateway nodes.</p><blockquote class=info-callout><p></p><p>As an example, this feature can be used in combination with legacy firewalls to allow traffic to legacy infrastructure only from specific pods within a given namespace. The pods typically have ever-changing IP addresses, and even if masquerading was to be used as a way to mitigate this, the IP addresses of nodes can also change frequently over time.</p></blockquote><a href=#installation-concerns><h2 id=installation-concerns><span class=hanchor arialabel=Anchor># </span>Installation concerns</h2></a><p>There is two installation modes for Cilium:</p><ul><li><a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/ rel=noopener>Using the CLI</a></li><li><a href=https://docs.cilium.io/en/stable/installation/k8s-install-helm/ rel=noopener>Using an helm chart</a></li></ul><p>For both configurations, the steps are as follows:</p><ul><li>Patch managed node groups taints</li><li>Install cilium with helm chart</li><li>Restart unmanaged pods</li><li>Validate installation</li></ul><p>Some steps, such as patching the
<a href=/thoughts/aws-vpc-cni/ rel=noopener class=internal-link data-src=/thoughts/aws-vpc-cni/>aws vpc cni</a>, are not explicit in the CLI documentation and may be hidden, so we need to compare the two implementations to see if any differences exist and what they imply. Same for
<a href=https://docs.cilium.io/en/stable/network/concepts/routing/#aws-eni rel=noopener>ENI integration as a requirement or not</a>.</p><p>For the Helm chart, this means that some steps are manual. We can check out a way to manage our own Helm chart that includes Cilium&rsquo;s and add a Job to perform these steps.</p><p>For the observability part with Hubble, this is the same as for Cilium, we can install with the
<a href=https://docs.cilium.io/en/stable/gettingstarted/hubble_setup/ rel=noopener>CLI or an Helm chart</a>, with some configuration:</p><ul><li><a href=https://docs.cilium.io/en/stable/gettingstarted/hubble-configuration/#tls-certificates rel=noopener>TLS certificates</a> (with
<a href=https://docs.cilium.io/en/stable/gettingstarted/hubble-configuration/#auto-generated-certificates-via-cert-manager rel=noopener>cert-manager</a>? or
<a href=https://docs.cilium.io/en/stable/gettingstarted/hubble-configuration/#auto-generated-certificates-via-helm rel=noopener>auto-generated via Helm</a>)</li><li><a href=https://docs.cilium.io/en/stable/gettingstarted/hubble/#enable-the-hubble-ui rel=noopener>Enable UI</a></li></ul><a href=#specific-configurations><h3 id=specific-configurations><span class=hanchor arialabel=Anchor># </span>Specific Configurations</h3></a><a href=#tunnel-mode><h4 id=tunnel-mode><span class=hanchor arialabel=Anchor># </span>Tunnel mode</h4></a><ul><li><strong>Overlay:</strong> Encapsulation-based virtual network spanning all hosts. Currently
<a href=https://en.wikipedia.org/wiki/Virtual_Extensible_LAN rel=noopener>VXLAN</a> (default) and
<a href=https://www.redhat.com/en/blog/what-geneve rel=noopener>Geneve</a> are baked in but all encapsulation formats supported by Linux can be enabled.</li><li><strong>Native routing:</strong> (see integration with Amazon VPC CNI section)</li></ul><a href=#bandwith-manager><h4 id=bandwith-manager><span class=hanchor arialabel=Anchor># </span>Bandwith manager</h4></a><p><a href=https://docs.cilium.io/en/stable/network/kubernetes/bandwidth-manager/ rel=noopener>Bandwidth Manager — Cilium 1.14.0 documentation</a></p><a href=#kube-proxy-replacement><h4 id=kube-proxy-replacement><span class=hanchor arialabel=Anchor># </span>Kube-proxy replacement</h4></a><p><a href="https://www.youtube.com/watch?v=SGfMEpjq07Q&amp;list=PLDg_GiBbAx-mY3VFLPbLHcxo6wUjejAOC&amp;index=47" rel=noopener>eCHO Episode 53: Life of a Packet in Cilium Continued - YouTube</a>
<a href=https://docs.cilium.io/en/v1.9/gettingstarted/kubeproxy-free/#kube-proxy-hybrid-modes rel=noopener>Kubernetes Without kube-proxy — Cilium 1.9.18 documentation</a></p><table><thead><tr><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>One of the most, if not the most advanced CNI plugin</td><td>Not integrated with Amazon VPC CNI as it (
<a href=https://aws.github.io/aws-eks-best-practices/networking/sgpp/#enforcing-mode-use-standard-mode-in-the-following-situations rel=noopener>pods with Security Group will not be impacted by the network policies</a> as they are on a branch ENI)</td></tr><tr><td>Open source</td><td>Network skills will be needed to understand what&rsquo;s going on and to be able to debug.</td></tr><tr><td>Manage toFQDN egress endpoints</td><td></td></tr><tr><td>User friendly observability with Hubble</td><td></td></tr></tbody></table><hr><div class=page-end id=footer><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://digital-garden.erdrix.konpyutaika.com/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><ul><li><a href=https://digital-garden.erdrix.konpyutaika.com/>Home</a></li><li><a href=https://twitter.com/AlexandreGuitt>Twitter</a></li><li><a href=https://github.com/konpyutaika>Github</a></li></ul></footer></div></article><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/thoughts/aws-vpc-cni-x-cilium/ data-ctx=Cilium data-src=/thoughts/aws-vpc-cni-x-cilium class=internal-link>Amazon VPC CNI x Cilium</a></li></ul></div></div></body></html>